---
title: "【60億円流出】GitHub Token流出から始まったAPI改ざんとその対策"
emoji: "🔐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CICD", "github", "AWS", "Token"]
published: false
publication_name: omakase
---

## 前回の振り返り

[前回の記事](https://zenn.dev/omakase/articles/b2e85e51ca45ef)のリンクを踏まえて、前回どのように改ざんされ流出してしまったのか、どういった対策をしたのかを簡単に説明します。また、改ざんの原因については記載されていなかったため、本稿で[続報](https://www.kiln.fi/post/kiln-sabisunozai-jia-dong-oyobisekiyuriteiinsidentoniguan-suruqing-bao)に記載の根本原因が明確になったことを含めてどのような攻撃があったのか、どのような対策があるのかを分析していく旨を説明します。

## 根本原因はGitHub Access Tokenの漏洩

[インシデントの詳細](https://www.kiln.fi/post/kiln-sabisunozai-jia-dong-oyobisekiyuriteiinsidentoniguan-suruqing-bao)に記載されている事件の根本原因（Token の漏洩）について説明します。また、Token の漏洩からどのように攻撃されてしまったのか詳細に確認していく旨を記載し次のセクションに繋げます。

## 流出したTokenでの攻撃経路

それでは実際に漏洩した GitHub Access Token を利用してどのように攻撃し、流出までに至ったのかをフロー図を交えて見ていきましょう。

①Token→②CI 実行の悪用→③Secrets 収集→④k8s 侵入→⑤API 改ざん→⑥署名という流れのフロー図を記載し、下記リストに記載の内容とリンクさせます。

1. GitHub Access Token 漏洩：侵入経路を再度記載。Token 種別は不明の旨を記載し、後述セクションで説明することを記載します。
1. CI 実行の悪用（branch create/delete でトリガー）：どこでブランチを作成し、CICD をトリガーしたのかを記載します。また、ブランチの大量変更についても説明します。
1. Secrets 収集・クラウド横展開：Secrets や認証情報をどこから集め、それを使ってどの本番環境にアクセスしたのかを記載します。
1. Kubernetes 侵入（Connect API Pod）：稼働中の Kubernetes Pod に悪性のペイロードをどのように注入したのか、それをしたことで何が起きたのかを解説します。
1. API ロジックを改ざん：前回の記事で出てきた withdrawal authority を書き換える悪意のある Tx が追加されてしまったことについて説明します。
1. 署名（raw signing）：改ざんされた Tx に署名してしまい流出してしまった旨を記載し、当該の Staking Providor 企業は、事件前から Decode して検証することを推奨していた旨もここに記載します。

## 今回の攻撃手法への対策と前提知識

攻撃手法に対してどのような防御策が考えられるかについて次のセクションに繋がるように記載する。内容としては、前提知識として Token の種別と流出の一般的なパターンを見ていく旨を説明します。その後に流出を防ぐ、流出後の被害を最小限に留めるという２つの観点で見ていく旨を追記します。

### 前提知識

前提知識として Token の種別と流出する際の一般的なパターンを以下のセクションで見せ、その後の対策に繋げられるようにする。ここでは、２つの前提知識を確認したのちに流出のパターンに対する対策などを見ていきましょうという形で繋げます。

#### Tokenの種別

Token の種別が明確に言及されていないため、今回の事件に該当すると考えられる Token の種別を可能性が高い順に見ていきましょう。

1. Personal Access Token（PAT）：個人が発行するユーザートークンで操作範囲と発行期限などを説明。
1. OAuth App の Access Token：外部 SaaS/ツールが OAuth で取得する User Access Token（Prefix:gho\_）で操作範囲を記載、発行期限なども併せて説明。
1. GitHub App User OAuth Token：ユーザーが GitHub App に認可して得るユーザー向け Token（Prefix: ghu\_）で操作範囲を記載、発行期限なども併せて説明。
1. GitHub App Install Access Token：インストール済み App が発行する短命 Token（Prefix: ghs\_）で操作範囲を記載、発行期限なども併せて説明。

**補足：GITHUB_TOKEN**
Actions ジョブ開始時に自動発行される短命・リポジトリ限定のトークンのため、今回の事件には適さないことを補足として記載する。

#### 一般的な流出パターン

本節は private リポジトリを前提に整理します（public で追加発生しやすい点は各項目末尾の「Public 差分」で補足）。  
Token の流出原因は確定していないため、一般的な流出パターンを確認します。

1. 誤コミット/README や設定ファイルへの混入からの漏洩：Token をコードや設定ファイル、Readme に誤って Push して漏洩してしまう旨を記載。
1. CI/CD のログ・アーティファクトからの漏洩：各種ログ出力をした際に Token が露出してしまうところから漏洩に繋がることを記載。
1. Actions の権限/トリガー設計の不備からの漏洩：フォーク PR を信頼して実行することや、pull_request/pull_request_target の扱いを間違えるなどで漏洩してしまうことを記載。
1. セルフホスト Runner の隔離不備からの漏洩：セルフホスト Runner の権限分離や隔離が不足していてそこから Token が引き抜かれてしまうことを記載。
1. 端末側が侵害（開発者マシンのマルウェア/ブラウザセッション乗っ取り）され漏洩：クリップボードやブラウザ保存データ、SSH エージェントなどから Token やセッション情報を盗られてしまうことを記載。
1. サードパーティ連携（OAuth/GitHub App/Webhooks）の侵害からの漏洩：外部 SaaS/App の鍵・トークン管理不備や Webhook 署名未検証で、連携経由の窃取／偽イベント受理が起きて漏洩する旨を記載。
1. コンテナ/イメージ/キャッシュ層に残置しての漏洩：ビルド時の秘密がレイヤ／キャッシュ／成果物に残り、後続ジョブや他者に再取得されることを記載。
1. チケット/チャット/スクショ共有からの漏洩：PR/Slack などのツールへの貼付やスクショで認証情報が拡散されてしまうことを記載。

他にも人やツール、周辺 Saas にまで広げると際限なくパターンは出てきます。しかしながら、今回はあくまでコアなパターンとして８つを取り上げました。

### Tokenを流出させないための対策

Token の流出原因については、一般的な流出パターンで確認しました。ではそれらをどのように防ぐのかについてみていきましょう。

1. 誤コミット/README・設定混入：Secret scanning＋Push protection の有効化や `.gitignore` ＋ダミー値＋ `pre-commit`（gitleaks 等）でコミット前に検知・遮断する旨を記載。
1. CI/CD ログ・アーティファクト：ログに出力させない対策（`::add-mask::`／`set -x` 禁止）や、Artifacts/Cache は最小化＆短期保持・限定共有とする旨を記載。
1. Actions 権限/トリガー不備（露出観点）：外部 PR の自動起動禁止/手動承認、Secrets を渡すトリガーの限定など、“どのイベントで Secrets が露出しないか”に焦点を当てて記載。（※`permissions` の設定や外部 Action の SHA 固定は次のセクションに記載）
1. セルフホスト Runner 隔離：セルフホストは閉じたネットワーク内 or 使い捨て（エフェメラル）運用とし、ワークスペース/キャッシュの分離・一時ファイルの確実な削除について記載。
1. 端末侵害（PC/ブラウザ）：SSO＋2FA（Passkey）の必須化、EDR/OS 更新/ディスク暗号化、ブラウザ保存/クリップボード/SSH エージェントへの認証情報保存を禁止する旨を記載。
1. サードパーティ連携（OAuth/GitHub App/Webhooks）：OAuth は PKCE＋固定 redirect＋state 検証、App 秘密鍵は KMS 保管＋ローテーション＆許可リスト制、Webhook は Secret 必須で署名検証を実施する旨を記載。
1. コンテナ/イメージ/キャッシュ残置：ビルド時のシークレットは `--mount=type=secret` を設定し、`.npmrc` 等は成果物/キャッシュに含めない、公開イメージ/キャッシュは短期保持とする旨を記載。
1. チケット/チャット/スクショ：PR/Slack などに認証情報を貼らない。誤掲載時は**即ローテーション**する運用を記載。

### 被害を最小限に留めるための対策

次にもし Token が漏れてしまった場合でも被害を最小限にするにはどのような対策が有効かについてを説明します。

1. 本番に影響を与える CI/CD の経路を限定する：CICD の経路をどのように限定し、対策していくのかについて以下の５つのサブセクションで解説します。併せて Sample Yaml も提示し、どの部分がどの項目に該当するのか明記します。
   - Secrets は **Environment** を利用して分離し、**レビュワーの承認**を強制
   - **権限最小化**（`permissions: read` を **Default** 設定し、必要時のみ権限昇格）
   - **リポジトリシークレットに本番情報を置かない**（Environment/Org 側へ隔離）
   - **外部 Action のコミット SHA 固定**（タグではなくコミットにピン留め）
   - **`push: branches: [main]` などに限定**して Secrets を渡す
   - 上記の内容を **Sample YAML** で記載

1. 長期シークレットの撤廃：長期シークレットをどのように撤廃し、対策するのかについて以下の３つのサブセクションで詳細を説明します。こちらも先ほどのセクションと同様に Sample Yaml を提示。項目ともリンクさせます。
   - クラウド認証を OIDC に置換（導入手順と Sample YAML などを記載）
   - コンテナレジストリのトークン短命化（ECR、GHCR の Sample YAML を踏まえ記載）
   - PAT は原則禁止。導入せざるを得ない場合は fine-grained PAT ＆ 期限必須などの短命化を記載

1. 署名前デコードと不正トランザクションの検知  
   前回の記事に記載されているため、簡単に触れるのみとする（[前回記事](https://zenn.dev/omakase/articles/b2e85e51ca45ef)）。

## まとめ

記事のまとめを記載します。

## 参考リンク

掲載した各種リンク記載します。
